# WIP

## 目标
- 完成“首页 -> 剧本详情 -> 建卡 -> 进入游戏”的新流程
- 首页展示剧本列表与游戏记录，支持继续游戏
- 左侧边栏改为导航，设置放入登录后可用的 Modal
- 个人设置持久化（D1/KV）并在 get_session 返回
- 使用 zustand 管理关键全局状态（剧本/人物/游戏）
- 选择剧本/继续游戏时 URL 反映当前状态
- 接入 better-auth 登录/注册（不需要邮箱验证）
- 建立 D1 数据结构与 API（脚本 / 人物 / 游戏 / 用户）
- 保持两列布局 + 侧边栏，主游戏区 100% 高度
- OpenAI / Gemini provider 接入 + 默认模型配置
- 建立前端测试框架并覆盖关键流程

## Todo
- [x] 页面整体两列结构（左侧边栏 + 主游戏区）
- [x] 主游戏区固定 100% 高度，聊天区不分页
- [x] 拆分准备阶段（选择剧本 / 建卡）与游戏主界面
- [x] 示例 COC 剧本（两场景 + 两战斗）
- [x] D1 schema + seed
- [x] 脚本 / 人物 / 游戏 API
- [x] 人物卡保存与开始游戏流程串联
- [x] Vitest + RTL + 基础流程测试
- [x] 默认模型（OpenAI gpt-5-mini / Gemini gemini-3-flash-preview）
- [x] 补充“继续编辑人物卡 / 重新选择剧本”入口
- [x] 人物卡必须基于剧本创建（脚本清单 + scriptId 绑定）
- [x] 数据库改为 migrations 驱动（schema / seed 进入迁移）
- [x] 剧本可配置职业 / 出身 / 状态 / 属性范围
- [x] 人物卡创建读取剧本限定选项
- [x] 文档补充剧本与人物卡约束
- [x] 参考 COC 点购规则补充属性点总预算（脚本字段 + 校验 + UI 展示）
- [x] 新增剧本属性点预算迁移并执行本地迁移
- [x] character-creator 拆分至 400 行以内
- [x] 补充属性点预算相关测试
- [x] 首页剧本列表与游戏记录展示
- [x] 剧本详情页（建卡 + 返回首页 + 开始游戏）
- [x] 游戏记录继续游戏入口
- [x] 侧边栏导航与设置 Modal（登录后可用）
- [x] 个人设置存储与 get_session 返回
- [x] zustand 全局状态（剧本 / 人物 / 游戏）与人物卡联动
- [x] URL 同步（/scripts/:id /games/:id）
- [x] better-auth 邮箱 + 密码登录/注册（API + UI）
- [x] better-auth 表迁移与本地执行
- [x] 动态路由：/scripts/:id 与 /games/:id
- [x] 登录/注册改为密码模式（移除 magic link）
- [x] 人物卡绑定登录用户（user_id + API 权限）
- [x] 游戏记录按用户过滤
- [x] 更新前端流程测试（AuthModal / HomeStage）
- [x] 核对 COC 点购规则（属性总预算）并补充测试/文档
- [x] 权限相关 API 测试（characters / games / games/:id）
- [x] 属性推荐最低值提示（不强制）与点购范围说明
- [x] 人物卡支持头像上传（表结构 + 表单 + 展示）
- [x] 进入游戏时生命/理智等数值满值初始化
- [x] 剧本内配置启动对话（数据结构 + 读取展示）
- [x] 游戏内聊天对接 AI API（OpenAI / Gemini）
- [x] 核对并更新 R2 桶名为 dnd
- [ ] 补充 API 异常与加载状态测试（可选）
- [ ] 检查响应式与信息密度
- [x] 聊天记录持久化（表结构 / API / 加载）
- [x] 聊天流式输出（SSE + 前端解析）
- [x] 聊天模块化渲染（叙事 / 掷骰 / 绘图 / 建议）
- [x] 快速模型输入解析与路由（合法性 + 处理策略）
- [x] 规则/房规/游戏内 DC 优先级与持久化（rules_json + rule_overrides_json）
- [x] 服务端检定函数（checkSkill/checkAttribute/checkLuck/checkSanity）与 action-executor 接入
- [x] 技能值改为数值（训练/未训练默认值 + 可选点购预算）
- [x] 角色创建支持技能点数分配（由剧本配置决定）
- [x] 角色创建技能点 UI 与校验（预算提示、数值输入）
- [x] 技能显示/解析改为数值（人物卡/AI 解析/文案）
- [x] 更新相关测试与修复重复定义

## 问题与待确认
- 数据库初始化由你执行？是否需要我补一份运行指引到文档
- 场景地图里需要展示的实体类型与密度上限
